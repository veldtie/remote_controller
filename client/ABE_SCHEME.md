# ABE (App-Bound Encryption) - Подробная схема

## 📊 Общая архитектура

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           CHROME 127+ (ABE)                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   ┌──────────────────┐         ┌──────────────────┐                         │
│   │   Local State    │         │   Cookies DB     │                         │
│   │                  │         │                  │                         │
│   │  encrypted_key:  │         │  encrypted_value │                         │
│   │  "APPB..." (ABE) │         │  "v20..." (ABE)  │                         │
│   │  "DPAPI..." (old)│         │  "v10..." (old)  │                         │
│   └────────┬─────────┘         └────────┬─────────┘                         │
│            │                            │                                    │
│            ▼                            ▼                                    │
│   ┌──────────────────┐         ┌──────────────────┐                         │
│   │  Key Decryption  │         │ Value Decryption │                         │
│   │                  │         │                  │                         │
│   │  APPB → IElevator│────────▶│  AES-256-GCM     │                         │
│   │  DPAPI → win32   │  key    │  nonce + cipher  │                         │
│   └──────────────────┘         └──────────────────┘                         │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 🔐 Форматы шифрования

### Ключ в Local State (`os_crypt.encrypted_key`)

```
┌─────────────────────────────────────────────────────────────────┐
│                    ENCRYPTED KEY FORMAT                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Chrome < 127 (DPAPI):                                          │
│  ┌────────┬──────────────────────────────────────┐              │
│  │ DPAPI  │         DPAPI-encrypted data         │              │
│  │ 5 bytes│              N bytes                 │              │
│  └────────┴──────────────────────────────────────┘              │
│                                                                  │
│  Chrome 127+ (ABE):                                             │
│  ┌────────┬──────────────────────────────────────┐              │
│  │ APPB   │      App-Bound encrypted data        │              │
│  │ 4 bytes│              N bytes                 │              │
│  └────────┴──────────────────────────────────────┘              │
│                                                                  │
│  После расшифровки → 32 байта (AES-256 key)                     │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### Зашифрованное значение cookie/password

```
┌─────────────────────────────────────────────────────────────────┐
│                 ENCRYPTED VALUE FORMAT                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌────────┬────────────┬─────────────────────────┐              │
│  │ Prefix │   Nonce    │  Ciphertext + GCM Tag   │              │
│  │ 3 bytes│  12 bytes  │        N bytes          │              │
│  └────────┴────────────┴─────────────────────────┘              │
│                                                                  │
│  Prefix types:                                                   │
│  • v10, v11, v12 - Standard DPAPI key encryption                │
│  • v20           - ABE encryption (Chrome 127+)                 │
│                                                                  │
│  AES-GCM Parameters:                                            │
│  • Key size:  256 bits (32 bytes)                               │
│  • Nonce:     96 bits (12 bytes)                                │
│  • Tag:       128 bits (16 bytes, included in ciphertext)       │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🔄 Процесс расшифровки

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        DECRYPTION FLOW                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  STEP 1: Load encrypted key from Local State                                │
│  ════════════════════════════════════════════                               │
│                                                                              │
│    Local State (JSON)                                                        │
│    ┌────────────────────────────────────┐                                   │
│    │ {                                  │                                   │
│    │   "os_crypt": {                    │                                   │
│    │     "encrypted_key": "BASE64..."   │ ◄─── base64 decode               │
│    │   }                                │                                   │
│    │ }                                  │                                   │
│    └────────────────────────────────────┘                                   │
│                         │                                                    │
│                         ▼                                                    │
│    ┌────────────────────────────────────┐                                   │
│    │  Check prefix: APPB or DPAPI?      │                                   │
│    └────────────────────────────────────┘                                   │
│                         │                                                    │
│           ┌─────────────┴─────────────┐                                     │
│           ▼                           ▼                                     │
│    ┌─────────────┐             ┌─────────────┐                              │
│    │    APPB     │             │    DPAPI    │                              │
│    │  (Chrome    │             │  (Chrome    │                              │
│    │   127+)     │             │   < 127)    │                              │
│    └──────┬──────┘             └──────┬──────┘                              │
│           │                           │                                      │
│           ▼                           ▼                                      │
│                                                                              │
│  STEP 2: Decrypt the key                                                    │
│  ═══════════════════════                                                    │
│                                                                              │
│    ABE Key Decryption:                 DPAPI Key Decryption:                │
│    ┌─────────────────────┐             ┌─────────────────────┐              │
│    │ Method 1: CDP       │             │ win32crypt.         │              │
│    │ (recommended)       │             │ CryptUnprotectData  │              │
│    ├─────────────────────┤             │                     │              │
│    │ Method 2: IElevator │             │ Returns 32-byte key │              │
│    │ COM interface       │             └─────────────────────┘              │
│    ├─────────────────────┤                                                  │
│    │ Method 3: DPAPI     │                                                  │
│    │ (fallback)          │                                                  │
│    └─────────────────────┘                                                  │
│                         │                                                    │
│                         ▼                                                    │
│    ┌────────────────────────────────────┐                                   │
│    │     32-byte AES-256 Key            │                                   │
│    │  (used for all v10/v20 values)     │                                   │
│    └────────────────────────────────────┘                                   │
│                         │                                                    │
│                         ▼                                                    │
│                                                                              │
│  STEP 3: Decrypt cookie/password value                                      │
│  ═════════════════════════════════════                                      │
│                                                                              │
│    ┌────────────────────────────────────┐                                   │
│    │  encrypted_value from DB           │                                   │
│    │  "v20" + nonce(12) + ciphertext    │                                   │
│    └────────────────────────────────────┘                                   │
│                         │                                                    │
│                         ▼                                                    │
│    ┌────────────────────────────────────┐                                   │
│    │  AES-256-GCM Decrypt               │                                   │
│    │                                    │                                   │
│    │  AESGCM(key).decrypt(              │                                   │
│    │    nonce=value[3:15],              │                                   │
│    │    ciphertext=value[15:],          │                                   │
│    │    associated_data=None            │                                   │
│    │  )                                 │                                   │
│    └────────────────────────────────────┘                                   │
│                         │                                                    │
│                         ▼                                                    │
│    ┌────────────────────────────────────┐                                   │
│    │     Decrypted plaintext            │                                   │
│    │     (cookie value / password)      │                                   │
│    └────────────────────────────────────┘                                   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 🛠 Методы расшифровки ABE ключа

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    ABE KEY DECRYPTION METHODS                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ METHOD 1: CDP (Chrome DevTools Protocol) ⭐ RECOMMENDED             │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                     │    │
│  │  Преимущества:                                                      │    │
│  │  • Cookies уже расшифрованы Chrome'ом                               │    │
│  │  • Не нужно расшифровывать ключ                                     │    │
│  │  • Работает на любой версии Chrome                                  │    │
│  │                                                                     │    │
│  │  Как использовать:                                                  │    │
│  │  1. Запустить Chrome: chrome.exe --remote-debugging-port=9222      │    │
│  │  2. Подключиться по WebSocket к ws://127.0.0.1:9222                │    │
│  │  3. Отправить: {"method": "Network.getAllCookies"}                 │    │
│  │  4. Получить расшифрованные cookies                                 │    │
│  │                                                                     │    │
│  │  ⚠️ Chrome должен быть запущен с debug портом                       │    │
│  │                                                                     │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ METHOD 2: IElevator COM Interface                                   │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                     │    │
│  │  Chrome Elevation Service предоставляет COM интерфейс:              │    │
│  │                                                                     │    │
│  │  CLSID (Chrome Stable): {708860E0-F641-4611-8895-7D867DD3675B}     │    │
│  │  IID (IElevator):       {A949CB4E-C4F9-44C4-B213-6BF8AA9AC69C}     │    │
│  │                                                                     │    │
│  │  Методы интерфейса:                                                 │    │
│  │  ┌─────────────────────────────────────────────────────────────┐   │    │
│  │  │ DecryptData(ciphertext, len) → plaintext                    │   │    │
│  │  │ EncryptData(plaintext, len)  → ciphertext                   │   │    │
│  │  └─────────────────────────────────────────────────────────────┘   │    │
│  │                                                                     │    │
│  │  Требования:                                                        │    │
│  │  • Служба "Google Chrome Elevation Service" должна работать        │    │
│  │  • Может требовать права администратора                             │    │
│  │  • comtypes или pywin32 для Python                                  │    │
│  │                                                                     │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ METHOD 3: Direct DPAPI (Fallback)                                   │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                     │    │
│  │  Иногда работает на некоторых конфигурациях:                        │    │
│  │                                                                     │    │
│  │  win32crypt.CryptUnprotectData(                                    │    │
│  │      encrypted_key[4:],  # Remove APPB prefix                      │    │
│  │      None,               # Description                              │    │
│  │      None,               # Optional entropy                         │    │
│  │      None,               # Reserved                                 │    │
│  │      0                   # Flags                                    │    │
│  │  )                                                                  │    │
│  │                                                                     │    │
│  │  Флаги для попытки:                                                 │    │
│  │  • 0x00 - Default                                                   │    │
│  │  • 0x01 - CRYPTPROTECT_UI_FORBIDDEN                                │    │
│  │  • 0x04 - CRYPTPROTECT_LOCAL_MACHINE                               │    │
│  │                                                                     │    │
│  │  ⚠️ Обычно не работает для ABE из-за привязки к приложению         │    │
│  │                                                                     │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 📁 Структура файлов проекта

```
remote_controller/
├── client/
│   └── remote_client/
│       ├── cookie_extractor/
│       │   ├── __init__.py
│       │   ├── app_bound_encryption.py  ◄── Главный ABE модуль
│       │   │   │
│       │   │   ├── is_abe_encrypted_key()      # Проверка APPB префикса
│       │   │   ├── is_abe_encrypted_value()    # Проверка v20 префикса
│       │   │   ├── decrypt_abe_key()           # Расшифровка ключа
│       │   │   ├── decrypt_abe_value()         # Расшифровка значения
│       │   │   ├── decrypt_v20_value()         # Удобная обёртка
│       │   │   ├── decrypt_abe_key_with_dpapi()# DPAPI метод
│       │   │   ├── _try_ielevator_com_decrypt()# IElevator метод
│       │   │   ├── AppBoundDecryptor           # Высокоуровневый класс
│       │   │   └── CDPCookieExtractor          # CDP экстрактор
│       │   │
│       │   ├── decrypt.py                      # Общие функции расшифровки
│       │   ├── extractors.py                   # Экстракторы для браузеров
│       │   └── browsers.py                     # Конфигурация браузеров
│       │
│       └── abe_status.py                       # Диагностика ABE
│
├── password_extractor/
│   └── extractor.py                            # Извлечение паролей
│
└── tests/
    └── test_app_bound_encryption.py            # Тесты ABE
```

---

## 🔌 API использования

```python
# ═══════════════════════════════════════════════════════════════
# Вариант 1: Высокоуровневый API (AppBoundDecryptor)
# ═══════════════════════════════════════════════════════════════

from remote_client.cookie_extractor.app_bound_encryption import AppBoundDecryptor

# Создаём декриптор (автоопределение пути)
decryptor = AppBoundDecryptor()

# Проверяем доступность
if decryptor.is_available:
    # Расшифровываем значение
    plaintext = decryptor.decrypt_value(encrypted_cookie_value)
    print(f"Cookie: {plaintext}")


# ═══════════════════════════════════════════════════════════════
# Вариант 2: CDP метод (рекомендуется для Chrome 127+)
# ═══════════════════════════════════════════════════════════════

from remote_client.cookie_extractor.app_bound_encryption import (
    CDPCookieExtractor,
    try_cdp_cookie_extraction
)

# Простой вызов
success, cookies = try_cdp_cookie_extraction("chrome")
if success:
    for cookie in cookies:
        print(f"{cookie['domain']}: {cookie['name']}={cookie['value']}")

# Или через контекстный менеджер
with CDPCookieExtractor() as extractor:
    cookies = extractor.get_all_cookies()


# ═══════════════════════════════════════════════════════════════
# Вариант 3: Низкоуровневый API
# ═══════════════════════════════════════════════════════════════

from remote_client.cookie_extractor.app_bound_encryption import (
    is_abe_encrypted_key,
    decrypt_abe_key,
    decrypt_abe_value,
    load_abe_key_from_local_state,
)

# Загружаем ключ
key = load_abe_key_from_local_state()

if key:
    # Расшифровываем cookie
    encrypted_value = b"v20..." # из базы данных
    plaintext = decrypt_abe_value(encrypted_value, key)
```

---

## ⚠️ Типичные ошибки и решения

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       TROUBLESHOOTING                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ❌ ОШИБКА: "ABE key not available"                                         │
│  ────────────────────────────────────                                        │
│  Причина: Не удалось расшифровать APPB ключ                                 │
│  Решение:                                                                    │
│    1. Используйте CDP метод (запустите Chrome с --remote-debugging-port)   │
│    2. Проверьте службу Google Chrome Elevation Service                      │
│    3. Запустите от имени администратора                                     │
│                                                                              │
│  ❌ ОШИБКА: "InvalidTag" при AES-GCM расшифровке                            │
│  ─────────────────────────────────────────────────                          │
│  Причина: Неправильный ключ или повреждённые данные                         │
│  Решение:                                                                    │
│    1. Убедитесь что ключ 32 байта                                           │
│    2. Проверьте что это тот же профиль Chrome                               │
│    3. Cookie могла быть перезаписана                                        │
│                                                                              │
│  ❌ ОШИБКА: "database is locked"                                            │
│  ────────────────────────────────                                           │
│  Причина: Chrome держит базу открытой                                       │
│  Решение:                                                                    │
│    1. Закройте Chrome                                                        │
│    2. Или копируйте БД во временный файл (shutil.copyfile)                 │
│                                                                              │
│  ❌ ОШИБКА: "Class not registered" (IElevator)                              │
│  ─────────────────────────────────────────────                              │
│  Причина: Chrome Elevation Service не установлен/не работает                │
│  Решение:                                                                    │
│    1. Переустановите Chrome                                                  │
│    2. Используйте CDP метод вместо IElevator                                │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 📊 Сравнение версий Chrome

```
┌─────────────────┬──────────────────┬──────────────────┬─────────────────────┐
│  Chrome версия  │   Формат ключа   │  Формат cookies  │   Метод расшифровки │
├─────────────────┼──────────────────┼──────────────────┼─────────────────────┤
│  < 80           │   DPAPI          │   DPAPI direct   │   win32crypt        │
├─────────────────┼──────────────────┼──────────────────┼─────────────────────┤
│  80 - 126       │   DPAPI          │   v10/v11/v12    │   DPAPI + AES-GCM   │
├─────────────────┼──────────────────┼──────────────────┼─────────────────────┤
│  127+           │   APPB (ABE)     │   v20            │   IElevator/CDP     │
│  (включая 144)  │                  │                  │   + AES-GCM         │
└─────────────────┴──────────────────┴──────────────────┴─────────────────────┘
```
